#------------------------------------------------------------------------------#
#                          WFP Standardized Scripts
#            ENA Vulnerability Classification Methodology
#------------------------------------------------------------------------------#

# NOTES:
# This script is based on the vulnerability classification methodology recommended 
# for Essential Needs Assessments. This classification is based on the combination 
# of three indicators: the Economic Capacity to Meet Essential Needs (ECMEN), the 
# Livelihood Coping Index for Essential Needs (LCS-EN), and the Food Consumption 
# Score (FCS). However, the vulnerability classification methodology can be adapted 
# based on programme needs. See chapter 6 of the Essential Needs Assessment guidance 
# note for more details.

# The script assumes that ECMEN, LCS-EN, and FCS have already been computed based 
# on standard scripts available in github: 
# https://github.com/WFP-VAM/RAMResourcesScripts/tree/main/Indicators. 
# The following variables should have been defined before running this file:
#   ECMEN_exclAsst
#   ECMEN_exclAsst_SMEB		
#   Max_coping_behaviourEN
#   FCSCat28 
#   FCSCat21 

library(dplyr)

# Create temporary variables
data <- data %>%
  mutate(temp_ECMEN_categ = case_when(
    ECMEN_exclAsst == 1 ~ 0,
    ECMEN_exclAsst == 0 & ECMEN_exclAsst_SMEB == 1 ~ 1,
    ECMEN_exclAsst_SMEB == 0 ~ 2,
    TRUE ~ NA_real_
  ))

val_labels(data$temp_ECMEN_categ) <- c('above MEB' = 0, 'below MEB and above SMEB' = 1, 'below SMEB' = 2)

# Declare whether the 21 or 28 threshold is used for FCS
data <- data %>% 
  mutate(temp_FCS_categ = FCSCat21) # replace with FCSCat28 if the CO uses 28 threshold

# Classify households into vulnerability categories
data <- data %>%
  mutate(ENA_vulnerability = case_when(
    temp_ECMEN_categ == 2 | Max_coping_behaviourEN == 4 | temp_FCS_categ == 1 ~ 3,
    temp_ECMEN_categ == 2 & Max_coping_behaviourEN == 4 ~ 4,
    temp_ECMEN_categ == 2 & temp_FCS_categ == 1 ~ 4,
    Max_coping_behaviourEN == 4 & temp_FCS_categ == 1 ~ 4,
    temp_ECMEN_categ == 1 & Max_coping_behaviourEN < 4 & temp_FCS_categ %in% 2:3 ~ 2,
    temp_ECMEN_categ == 0 & Max_coping_behaviourEN == 3 & temp_FCS_categ %in% 2:3 ~ 2,
    temp_ECMEN_categ == 0 & Max_coping_behaviourEN < 3 & temp_FCS_categ == 2 ~ 2,
    temp_ECMEN_categ == 0 & Max_coping_behaviourEN < 3 & temp_FCS_categ == 3 ~ 1,
    TRUE ~ NA_real_
  ))

val_labels(data$ENA_vulnerability) <- c('Not vulnerable' = 1, 'Moderately vulnerable' = 2, 'Highly vulnerable' = 3, 'Extremely vulnerable' = 4)

# Calculate the population share in vulnerability tiers
table(data$ENA_vulnerability)

# Drop unnecessary variables
data <- data %>% select(-temp_ECMEN_categ, -temp_FCS_categ)

# End of Scripts